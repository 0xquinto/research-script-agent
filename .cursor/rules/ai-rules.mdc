---
alwaysApply: true
---

# Research Script Agent Architecture

## Project Structure

```
src/
├── core/              # Core AI module - OpenRouter integration
│   ├── ai.ts         # AICore class and default instance
│   └── index.ts      # Barrel exports
├── tools/             # Pluggable tools system
│   ├── calculator.ts  # Calculator tool example
│   ├── registry.ts    # Tool registry manager
│   ├── types.ts       # Tool type definitions
│   └── index.ts      # Barrel exports
├── cli/               # CLI interface
│   ├── chat.ts        # Interactive chat interface
│   └── index.ts       # Barrel exports
└── index.ts           # Main entry point
```

## Core AI Module

### Import

```typescript
// Option 1: Import from core module (recommended)
import { ai, AICore, type ChatMessage } from './core/ai';

// Option 2: Import from barrel export
import { ai, AICore } from './core';
```

### Quick Start

The `ai` instance is pre-configured with `openai/gpt-5.1-chat`:

```typescript
// Simple message
const response = await ai.sendMessage('Hello!');

// Full chat with options
const result = await ai.chat({
  messages: [
    { role: 'system', content: 'You are helpful.' },
    { role: 'user', content: 'Explain X' }
  ],
  temperature: 0.7,
  maxTokens: 100
});
console.log(result.content, result.model, result.usage);
```

### Per-Request Model Override

```typescript
// Override model for single request
await ai.sendMessage('Hello!', 'anthropic/claude-3.5-sonnet');
await ai.chat({ model: 'google/gemini-pro', messages: [...] });
```

### Custom Instance

```typescript
const customAI = new AICore({
  defaultModel: 'openai/gpt-4o-mini',
  apiKey: 'custom-key', // optional, uses env by default
});

await customAI.sendMessage('Hello!');
```

### Multi-Turn Conversations

```typescript
const response = await ai.sendConversation([
  { role: 'user', content: 'What is 2+2?' },
  { role: 'assistant', content: '2+2 equals 4.' },
  { role: 'user', content: 'What about 3+3?' }
]);
```

## Tools System

### Using Tools

Tools are automatically registered and available to the AI through the tool registry:

```typescript
import { toolRegistry } from './tools';

// Get all registered tools
const tools = toolRegistry.getAll();

// Get a specific tool
const calculator = toolRegistry.get('calculator');

// Parse a tool call from AI message
const parsedCall = toolRegistry.parseToolCall('CALL_TOOL add 2 2');

// Execute a tool call
if (parsedCall) {
  const result = await toolRegistry.executeToolCall(parsedCall);
}
```

### Creating a New Tool

1. **Create tool file** (`src/tools/my-tool.ts`):

```typescript
import type { Tool, ToolResult } from './types';

export const myTool: Tool = {
  name: 'mytool',
  description: 'Does something useful',
  
  parseCall(message: string): any | null {
    // Parse tool call from AI message
    // Return parsed args or null if not a match
    if (message.includes('CALL_TOOL mytool')) {
      // Extract arguments
      return { arg1: 'value1', arg2: 'value2' };
    }
    return null;
  },
  
  async execute(args: any): Promise<ToolResult> {
    try {
      // Execute tool logic
      const result = /* your logic */;
      return { success: true, result };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : String(error)
      };
    }
  }
};
```

2. **Register tool** in `src/tools/registry.ts`:

```typescript
import { myTool } from './my-tool';

constructor() {
  this.register(calculatorTool);
  this.register(myTool); // Add your tool
}
```

3. **Export tool** in `src/tools/index.ts`:

```typescript
export { myTool } from './my-tool';
```

The tool will automatically be available to the AI!

### Tool Interface

```typescript
interface Tool {
  name: string;                    // Unique tool identifier
  description: string;             // Description for AI system prompt
  parseCall: (message: string) => any | null;  // Parse AI message
  execute: (args: any) => Promise<ToolResult> | ToolResult;  // Execute tool
}
```

## CLI Module

### Using the Chat Interface

```typescript
import { startChat } from './cli';

// Start interactive chat (uses registered tools automatically)
await startChat();
```

The CLI automatically:
- Loads all registered tools
- Generates system prompt with tool descriptions
- Handles tool calls from AI responses
- Manages conversation context

## Configuration

Set in `.env`:
- `OPENROUTER_API_KEY` (required)
- `OPENROUTER_DEFAULT_MODEL` (optional, defaults to `openai/gpt-5.1-chat`)
- `OPENROUTER_SITE_URL` (optional, for rankings)
- `OPENROUTER_SITE_NAME` (optional, for rankings)

## Core AI Methods

- `ai.sendMessage(message: string, model?: string)` → `Promise<string>`
- `ai.sendConversation(messages: ChatMessage[], model?: string)` → `Promise<string>`
- `ai.chat(options: ChatCompletionOptions)` → `Promise<ChatCompletionResponse>`
- `ai.getDefaultModel()` → `string`
- `ai.setDefaultModel(model: string)` → `void`

## Architecture Principles

1. **Modularity**: Core AI, tools, and CLI are separate modules
2. **Pluggability**: Tools are registered and auto-discovered
3. **Type Safety**: Full TypeScript support throughout
4. **Separation of Concerns**: Each module has a single responsibility
5. **Extensibility**: Easy to add new tools without modifying core code
